<!-- Loading State -->
@if (loading()) {
  <div class="loading-container">
    <mat-progress-spinner mode="indeterminate" diameter="50"></mat-progress-spinner>
    <p>Loading book details...</p>
  </div>
}

<!-- Book Details -->
@if (!loading() && book()) {
  <div class="book-details-container">
    <!-- Back Button -->
    <div class="back-button-container">
      <button mat-button (click)="backToCatalog()">
        <mat-icon>arrow_back</mat-icon>
        Back to Catalog
      </button>
    </div>

    <!-- Book Card -->
    <mat-card class="book-details-card">
      <mat-card-header>
        <mat-icon mat-card-avatar class="book-icon">menu_book</mat-icon>
        <mat-card-title>{{ book()!.title }}</mat-card-title>
        <mat-card-subtitle>{{ book()!.author }}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <!-- Genre -->
        <div class="genre-container">
          <mat-chip class="genre-chip">{{ book()!.genre }}</mat-chip>
        </div>

        <!-- Publication Date -->
        <div class="publication-date">
          <mat-icon>calendar_today</mat-icon>
          <span>{{ book()!.publicationDate | date:'MMMM d, yyyy' }}</span>
        </div>


        <!-- Availability -->
        <div class="availability">
          <mat-icon
            [class.available]="book()!.availableCopies > 0"
            [class.unavailable]="book()!.availableCopies === 0"
          >
            {{ book()!.availableCopies > 0 ? 'check_circle' : 'cancel' }}
          </mat-icon>
          <span>{{ getAvailabilityText() }}</span>
        </div>

        <!-- Description -->
        <div class="description">
          <h3>Description</h3>
          <p>{{ book()!.description }}</p>
        </div>
      </mat-card-content>

      <mat-card-actions>
        @if (checkingStatus()) {
                <mat-spinner diameter="24"></mat-spinner>
              } @else {
                @if (showReturnButton) {
                  <!-- ðŸ†• Return button (user has borrowed this book) -->
                  <button 
                    mat-raised-button 
                    color="accent"
                    [disabled]="actionInProgress()"
                    (click)="returnBook()">
                    @if (actionInProgress()) {
                      <mat-spinner diameter="20"></mat-spinner>
                    } @else {
                      <mat-icon>keyboard_return</mat-icon>
                      Return Book
                    }
                  </button>
                  
                  <!-- ðŸ†• Link to view in "My Books" -->
                  <button 
                    mat-stroked-button
                    (click)="viewInMyBooks()">
                    View in My Books
                  </button>
                } @else {
                  <!-- Borrow button (user hasn't borrowed this book) -->
                  <button 
                    mat-raised-button 
                    color="primary"
                    [disabled]="!canBorrow || actionInProgress()"
                    (click)="borrowBook()">
                    @if (actionInProgress()) {
                      <mat-spinner diameter="20"></mat-spinner>
                    } @else {
                      <mat-icon>add_circle</mat-icon>
                      Borrow Book
                    }
                  </button>

                  @if (!canBorrow && book()!.availableCopies === 0) {
                    <p class="unavailable-message">
                      <mat-icon>info</mat-icon>
                      No copies currently available
                    </p>
                  }
                }
              }
      </mat-card-actions>
    </mat-card>
  </div>
}

<!-- Empty State -->
@if (!loading() && !book()) {
  <div class="empty-state">
    <mat-icon class="empty-icon">library_books</mat-icon>
    <h2>Book not found</h2>
    <p>The book you're looking for doesn't exist.</p>
    <button mat-raised-button color="primary" (click)="backToCatalog()">
      Back to Catalog
    </button>
  </div>
}
